<!DOCTYPE html>
<meta charset="utf-8">

<body>
<!--no static DOM element at all!-->
</body>

<script src="//d3js.org/d3.v4.min.js"></script>

<script>
// set initial values  
var svg, w, selectedDomEle;
var w = window;
var width_body = w.innerWidth || el.clientWidth || body.clientWidth;
var height_body = w.innerHeight|| el.clientHeight|| body.clientHeight;

// add title
d3.select('body').append('h2')
  .html('D3 to show mouse coordinates within the selected DOM element')
  d3.select('body').append('p')
  .html('Modified from "https://bl.ocks.org/mbostock/f7dcecb19c4af317e464"')

// add a svg  
var svg = d3.select('body').append('svg')
  .style('width', width_body)
  .style('height', height_body)
  // .style('background', 'lightgreen')
  .style('opacity', '1')
;

// add a rect, and enable it for pointer-events
var therect = svg.append('rect')
  .attr('width', width_body)
  .attr('height', height_body)
  .style('stroke', 'black')
  .style('fill', 'lightgreen')
  .style('pointer-events', 'all')
;

// set initial text string
var initialtext ='Left click and hold the mouse within the green area.';

// add a g DOM element in the svg (it is for moving, i.e., transform.translate)
var theg = svg.append('g');

/** add a text DOM element in the g. 
    It is to display hint text and the mouse coordinates(i.e., to left and to top of the selected DOM). 
    In this casse, the selected DOM is the rect
*/

// initial setting of the text box (i.e., text to display, alignment, and vertical offset )
var textbox=theg.append('text')
    .text(initialtext)
    .attr('text-anchor', 'start')
    .attr("dy", ".85em")

// when the mouse is pressed down, the following actions will be triggled    
d3.selectAll("rect").on("mousedown", function() {

  // remember the selected object (this means the selected object. In this case, it is the rect)
  selectedobj = d3.select(this)

  /** get the x and y coordinates of the selected DOM element. 
   * Note: 'this' is an object, 'this.node()' is a DOM element like <rect>...</rect>
   * 
   * d3.mouse(<anchoring DOM element>) is to get coordinates (i.e., the distance from the current mouse point to the
   * left/top border of a reference DOM element. The following is to get such coordinates to the selected
   * DOM Element, which is the rect. 
   * Note: the current point is the place where the mouse is pressed down. This is the point where
   *  the text group will fly to after the mouse is pressed down and hold. At that moment, the mouse is not moved yet. 
  */
  var tmpxyarray=d3.mouse(selectedobj.node());

  //calculate the coordinates and convert to strings for display and for transform.translate setting (i.e., for the text group to fly to)
  var
    mousecurrentxy = {"toLeft": parseInt(tmpxyarray[0]), "toTop": parseInt(tmpxyarray[1])},
    mousexystr="(" + mousecurrentxy.toLeft + ',' + mousecurrentxy.toTop  + ')',
    translatestr='translate ' + mousexystr;

  // let the text group fly to the point where the mouse is pressed down, change text hint contents  
  theg.transition().duration(2000)
    .attr('transform', translatestr);
  textbox.text('hold the mouse and move to get mouse coordinates');

  // add a listening event on mousemove/mouseup
  d3.select(window)
    .on("mousemove", mousemove)
    .on("mouseup", mouseup);
    
});


  // d3.event.preventDefault(); // disable text dragging. This is proposed in the original example,but is not used here


  // when the mouse is moved, the following actions will be triggled
  function mousemove() {

    /**get the coordinates of the current point to the reference DOM element (i.e., in this case, the rect). 
     * Note, the current point is the place where the mouse moves to. It changes as the mouse moves again. 
     *  This isdifferent from the mouse coordinates obtained above. In that step, the mouse coordinates represents
     *  the point where the mouse was pressed down.   
     * */
    var tmpxyarray=d3.mouse(selectedobj.node());
    // Again, calculate the coordinates and prepare hint/transform.translate strings
    var
    mousecurrentxy = {"toLeft": parseInt(tmpxyarray[0]), "toTop": parseInt(tmpxyarray[1])},
    mousexystr="(" + mousecurrentxy.toLeft + ',' + mousecurrentxy.toTop  + ')',
    translatestr='translate ' + mousexystr;

    // move the text g to the point where the mouse moves
    theg.attr('transform', translatestr);

    // display the mouse coordinates in the text box (It changes as the mouse moves)
    textbox
      .text(mousexystr).attr('text-anchor', 'start').attr("dy", "1.85em");
  }

  // when the mouse is up (released), the following actions will be triggled
  function mouseup() {
    // cancel listening to mousemove/mouseup (in fact, it is to DO NOTHING as mouse moves or released)
    d3.select(window).on("mousemove", null).on("mouseup", null);
    // let the text group return to the up left corner.
    theg.transition().duration(2000)
    .attr('transform', 'translate(0,0)');
    // let the text box have the initial settings.
    textbox.text(initialtext).attr('text-anchor', 'start').attr("dy", ".85em")
  }

</script>
